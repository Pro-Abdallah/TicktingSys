{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 244, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/hp/Downloads/ITTickting%20Sys/lib/db.ts"],"sourcesContent":["import mssql from 'mssql';\r\n\r\nconst config: any = {\r\n    server: process.env.DB_SERVER || 'DESKTOP-9M75GPK',\r\n    database: process.env.DB_NAME || 'ElsewedySchoolSysDB_DEV',\r\n    options: {\r\n        encrypt: process.env.DB_ENCRYPT === 'true',\r\n        trustServerCertificate: process.env.DB_TRUST_SERVER_CERTIFICATE === 'true',\r\n    },\r\n    pool: {\r\n        max: 10,\r\n        min: 0,\r\n        idleTimeoutMillis: 30000\r\n    }\r\n};\r\n\r\n// Use Integrated Security (Windows Authentication) if specified\r\nif (process.env.DB_INTEGRATED_SECURITY === 'true') {\r\n    config.options.trustedConnection = true;\r\n} else {\r\n    config.user = process.env.DB_USER;\r\n    config.password = process.env.DB_PASSWORD;\r\n}\r\n\r\n\r\nlet poolPromise: Promise<mssql.ConnectionPool> | null = null;\r\n\r\nexport async function getDbPool() {\r\n    if (poolPromise) return poolPromise;\r\n\r\n    poolPromise = mssql.connect(config as any);\r\n    return poolPromise;\r\n}\r\n\r\nexport async function query(sql: string, params: Record<string, any> = {}) {\r\n    const pool = await getDbPool();\r\n    const request = pool.request();\r\n\r\n    for (const [key, value] of Object.entries(params)) {\r\n        request.input(key, value);\r\n    }\r\n\r\n    return request.query(sql);\r\n}\r\n\r\nexport { mssql };\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,SAAc;IAChB,QAAQ,QAAQ,GAAG,CAAC,SAAS,IAAI;IACjC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,SAAS;QACL,SAAS,QAAQ,GAAG,CAAC,UAAU,KAAK;QACpC,wBAAwB,QAAQ,GAAG,CAAC,2BAA2B,KAAK;IACxE;IACA,MAAM;QACF,KAAK;QACL,KAAK;QACL,mBAAmB;IACvB;AACJ;AAEA,gEAAgE;AAChE,IAAI,QAAQ,GAAG,CAAC,sBAAsB,KAAK,QAAQ;IAC/C,OAAO,OAAO,CAAC,iBAAiB,GAAG;AACvC,OAAO;IACH,OAAO,IAAI,GAAG,QAAQ,GAAG,CAAC,OAAO;IACjC,OAAO,QAAQ,GAAG,QAAQ,GAAG,CAAC,WAAW;AAC7C;AAGA,IAAI,cAAoD;AAEjD,eAAe;IAClB,IAAI,aAAa,OAAO;IAExB,cAAc,8NAAK,CAAC,OAAO,CAAC;IAC5B,OAAO;AACX;AAEO,eAAe,MAAM,GAAW,EAAE,SAA8B,CAAC,CAAC;IACrE,MAAM,OAAO,MAAM;IACnB,MAAM,UAAU,KAAK,OAAO;IAE5B,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,OAAO,OAAO,CAAC,QAAS;QAC/C,QAAQ,KAAK,CAAC,KAAK;IACvB;IAEA,OAAO,QAAQ,KAAK,CAAC;AACzB"}},
    {"offset": {"line": 291, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/hp/Downloads/ITTickting%20Sys/app/api/auth/login/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { query } from '@/lib/db';\r\nimport * as crypto from 'crypto';\r\n\r\nexport async function POST(request: Request) {\r\n    try {\r\n        const { email, password } = await request.json();\r\n\r\n        if (!email || !password) {\r\n            return NextResponse.json(\r\n                { success: false, message: 'Email and password are required' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Step 1: Get login credentials\r\n        const loginResult = await query(\r\n            'SELECT LoginId, AccountId, Email, PasswordHash FROM Login WHERE Email = @email',\r\n            { email }\r\n        );\r\n\r\n        if (loginResult.recordset.length === 0) {\r\n            return NextResponse.json(\r\n                { success: false, message: 'Invalid email or password' },\r\n                { status: 401 }\r\n            );\r\n        }\r\n\r\n        const login = loginResult.recordset[0];\r\n\r\n        // Step 2: Verify password\r\n        const passwordHash = crypto.createHash('sha256').update(password).digest('hex');\r\n\r\n        if (passwordHash !== login.PasswordHash) {\r\n            return NextResponse.json(\r\n                { success: false, message: 'Invalid email or password' },\r\n                { status: 401 }\r\n            );\r\n        }\r\n\r\n        // Step 3: Get account information\r\n        const accountResult = await query(\r\n            'SELECT AccountId, Email, Phone, FullNameEN, FullNameAR FROM Accounts WHERE AccountId = @accountId',\r\n            { accountId: login.AccountId }\r\n        );\r\n\r\n        if (accountResult.recordset.length === 0) {\r\n            return NextResponse.json(\r\n                { success: false, message: 'Account not found' },\r\n                { status: 404 }\r\n            );\r\n        }\r\n\r\n        const account = accountResult.recordset[0];\r\n\r\n        // Step 4: Get roles via AccountRoles junction table\r\n        const rolesResult = await query(`\r\n            SELECT r.RoleId, r.RoleName, r.BusinessEntity\r\n            FROM Roles r\r\n            INNER JOIN AccountRoles ar ON r.RoleId = ar.RoleId\r\n            WHERE ar.AccountId = @accountId AND r.BusinessEntity = 'TicTrack'\r\n        `, { accountId: login.AccountId });\r\n\r\n        if (rolesResult.recordset.length === 0) {\r\n            return NextResponse.json(\r\n                { success: false, message: 'No TicTrack role found for this account' },\r\n                { status: 403 }\r\n            );\r\n        }\r\n\r\n        const roles = rolesResult.recordset;\r\n        const primaryRole = roles[0]; // Use first role if multiple\r\n\r\n        // Step 5: Determine portal based on role\r\n        const studentRoles = ['Student'];\r\n        const itPortalRoles = ['IT', 'Teacher', 'TechStaff', 'Reviewer', 'Board'];\r\n\r\n        let portalType = 'unknown';\r\n        if (studentRoles.includes(primaryRole.RoleName)) {\r\n            portalType = 'student';\r\n        } else if (itPortalRoles.includes(primaryRole.RoleName)) {\r\n            portalType = 'it';\r\n        }\r\n\r\n        // Step 6: Return user info and portal type\r\n        return NextResponse.json({\r\n            success: true,\r\n            user: {\r\n                accountId: account.AccountId,\r\n                email: account.Email,\r\n                fullNameEN: account.FullNameEN,\r\n                fullNameAR: account.FullNameAR,\r\n                phone: account.Phone,\r\n                role: primaryRole.RoleName,\r\n                portalType\r\n            }\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error('Login error:', error);\r\n        return NextResponse.json(\r\n            { success: false, message: 'Internal server error', error: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,OAAgB;IACvC,IAAI;QACA,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE9C,IAAI,CAAC,SAAS,CAAC,UAAU;YACrB,OAAO,gTAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;gBAAO,SAAS;YAAkC,GAC7D;gBAAE,QAAQ;YAAI;QAEtB;QAEA,gCAAgC;QAChC,MAAM,cAAc,MAAM,IAAA,oKAAK,EAC3B,kFACA;YAAE;QAAM;QAGZ,IAAI,YAAY,SAAS,CAAC,MAAM,KAAK,GAAG;YACpC,OAAO,gTAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;gBAAO,SAAS;YAA4B,GACvD;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,QAAQ,YAAY,SAAS,CAAC,EAAE;QAEtC,0BAA0B;QAC1B,MAAM,eAAe,mHAAiB,CAAC,UAAU,MAAM,CAAC,UAAU,MAAM,CAAC;QAEzE,IAAI,iBAAiB,MAAM,YAAY,EAAE;YACrC,OAAO,gTAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;gBAAO,SAAS;YAA4B,GACvD;gBAAE,QAAQ;YAAI;QAEtB;QAEA,kCAAkC;QAClC,MAAM,gBAAgB,MAAM,IAAA,oKAAK,EAC7B,qGACA;YAAE,WAAW,MAAM,SAAS;QAAC;QAGjC,IAAI,cAAc,SAAS,CAAC,MAAM,KAAK,GAAG;YACtC,OAAO,gTAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;gBAAO,SAAS;YAAoB,GAC/C;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,UAAU,cAAc,SAAS,CAAC,EAAE;QAE1C,oDAAoD;QACpD,MAAM,cAAc,MAAM,IAAA,oKAAK,EAAC,CAAC;;;;;QAKjC,CAAC,EAAE;YAAE,WAAW,MAAM,SAAS;QAAC;QAEhC,IAAI,YAAY,SAAS,CAAC,MAAM,KAAK,GAAG;YACpC,OAAO,gTAAY,CAAC,IAAI,CACpB;gBAAE,SAAS;gBAAO,SAAS;YAA0C,GACrE;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,QAAQ,YAAY,SAAS;QACnC,MAAM,cAAc,KAAK,CAAC,EAAE,EAAE,6BAA6B;QAE3D,yCAAyC;QACzC,MAAM,eAAe;YAAC;SAAU;QAChC,MAAM,gBAAgB;YAAC;YAAM;YAAW;YAAa;YAAY;SAAQ;QAEzE,IAAI,aAAa;QACjB,IAAI,aAAa,QAAQ,CAAC,YAAY,QAAQ,GAAG;YAC7C,aAAa;QACjB,OAAO,IAAI,cAAc,QAAQ,CAAC,YAAY,QAAQ,GAAG;YACrD,aAAa;QACjB;QAEA,2CAA2C;QAC3C,OAAO,gTAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,MAAM;gBACF,WAAW,QAAQ,SAAS;gBAC5B,OAAO,QAAQ,KAAK;gBACpB,YAAY,QAAQ,UAAU;gBAC9B,YAAY,QAAQ,UAAU;gBAC9B,OAAO,QAAQ,KAAK;gBACpB,MAAM,YAAY,QAAQ;gBAC1B;YACJ;QACJ;IAEJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,gTAAY,CAAC,IAAI,CACpB;YAAE,SAAS;YAAO,SAAS;YAAyB,OAAO,MAAM,OAAO;QAAC,GACzE;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}